<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>L'Espace Mathématique</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #0b0e14;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            touch-action: none; 
            user-select: none;
            -webkit-user-select: none;
        }
        canvas {
            display: block;
        }
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            color: white;
            z-index: 10;
        }
        .hud-container {
            width: 100%;
            display: flex;
            justify-content: center;
            pointer-events: none;
        }
        .hud-panel {
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            display: flex;
            gap: 30px;
            pointer-events: auto;
        }
        .target-box {
            position: absolute;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(220, 38, 38, 0.85);
            padding: 10px 30px;
            border-radius: 15px;
            border: 2px solid white;
            text-align: center;
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.5);
            pointer-events: none;
        }
        #target-instruction {
            display: block;
            font-size: 0.8rem;
            text-transform: uppercase;
            opacity: 0.9;
            margin-bottom: -5px;
        }
        #target-value {
            font-size: 2rem;
            font-weight: bold;
        }
        .hidden { display: none !important; }

        /* Contrôles tactiles */
        #touch-controls {
            position: absolute;
            bottom: 40px;
            right: 40px;
            z-index: 50;
            pointer-events: auto;
        }
        .fire-button {
            width: 90px;
            height: 90px;
            background: rgba(220, 38, 38, 0.7);
            border: 4px solid white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.3rem;
            box-shadow: 0 0 25px rgba(220, 38, 38, 0.5);
            touch-action: none;
        }
        .fire-button:active {
            transform: scale(0.9);
            background: rgba(220, 38, 38, 0.9);
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="hud-container">
            <div class="hud-panel shadow-lg">
                <div class="flex flex-col items-center">
                    <span class="text-xs uppercase opacity-70">Score</span>
                    <span id="score" class="text-xl font-bold">0</span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-xs uppercase opacity-70">Vies</span>
                    <span id="lives" class="text-xl font-bold text-red-400">3</span>
                </div>
                <div class="flex flex-col items-center">
                    <span class="text-xs uppercase opacity-70">Temps</span>
                    <span id="timer" class="text-xl font-bold text-yellow-400">03:00</span>
                </div>
                <button id="home-btn" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-sm self-center transition">MENU</button>
            </div>
        </div>

        <div id="target-display" class="target-box hidden">
            <span id="target-instruction">TROUVE LE DOUBLE DE</span>
            <span id="target-value">--</span>
        </div>

        <div id="overlay" class="absolute inset-0 bg-black/80 flex items-center justify-center pointer-events-auto">
            <div class="bg-gray-900 p-8 rounded-3xl border-2 border-red-500 max-w-md w-full mx-4 shadow-2xl text-center">
                <h1 id="overlay-title" class="text-4xl font-black text-red-500 mb-4 tracking-widest uppercase">Espace Maths</h1>
                <p id="overlay-msg" class="text-gray-300 mb-8 leading-relaxed">
                    Détruis les astéroïdes qui correspondent à la consigne affichée !
                </p>
                
                <div class="mb-6">
                    <label class="block text-sm text-gray-500 mb-2 uppercase tracking-tighter">Mode de jeu</label>
                    <select id="game-mode" class="bg-gray-800 text-white border border-gray-700 rounded-lg px-4 py-2 w-full focus:outline-none focus:border-red-500">
                        <option value="doubles">Doubles & Moitiés</option>
                        <option value="friends10">Les Amis de 10</option>
                    </select>
                </div>

                <div class="mb-8">
                    <label class="block text-sm text-gray-500 mb-2 uppercase tracking-tighter">Difficulté</label>
                    <select id="diff-select" class="bg-gray-800 text-white border border-gray-700 rounded-lg px-4 py-2 w-full focus:outline-none focus:border-red-500">
                        <option value="easy">Recrue (1-10)</option>
                        <option value="medium" selected>Pilote (1-20)</option>
                        <option value="hard">Commandant (1-50)</option>
                    </select>
                </div>

                <button id="start-btn" class="bg-red-600 hover:bg-red-500 text-white font-bold py-4 px-10 rounded-full text-xl transition-all transform hover:scale-105 shadow-lg shadow-red-900/40">
                    LANCER LA MISSION
                </button>
            </div>
        </div>
    </div>

    <!-- Interface tactile pour le tir -->
    <div id="touch-controls" class="hidden">
        <button id="fire-btn" class="fire-button">FEU !</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const scoreEl = document.getElementById('score');
        const livesEl = document.getElementById('lives');
        const timerEl = document.getElementById('timer');
        const overlay = document.getElementById('overlay');
        const overlayTitle = document.getElementById('overlay-title');
        const overlayMsg = document.getElementById('overlay-msg');
        const startBtn = document.getElementById('start-btn');
        const homeBtn = document.getElementById('home-btn');
        const diffSelect = document.getElementById('diff-select');
        const modeSelect = document.getElementById('game-mode');
        const targetDisplay = document.getElementById('target-display');
        const targetValEl = document.getElementById('target-value');
        const targetInstEl = document.getElementById('target-instruction');
        const touchControls = document.getElementById('touch-controls');
        const fireBtn = document.getElementById('fire-btn');

        // Assets
        const images = {
            ship: new Image(),
            laser: new Image(),
            meteors: [new Image(), new Image(), new Image(), new Image()]
        };
        images.ship.src = 'playerShip1_red.png';
        images.laser.src = 'laserRed13.png';
        images.meteors[0].src = 'meteorBrown_big1.png';
        images.meteors[1].src = 'meteorBrown_big2.png';
        images.meteors[2].src = 'meteorBrown_big3.png';
        images.meteors[3].src = 'meteorBrown_big4.png';

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let ambientSource = null;

        function playSound(freq, type, duration) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function startSpaceAmbience() {
            if (ambientSource) return;
            const bufferSize = 2 * audioCtx.sampleRate;
            const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const output = noiseBuffer.getChannelData(0);
            for (let i = 0; i < bufferSize; i++) {
                output[i] = Math.random() * 2 - 1;
            }
            ambientSource = audioCtx.createBufferSource();
            ambientSource.buffer = noiseBuffer;
            ambientSource.loop = true;
            const filter = audioCtx.createBiquadFilter();
            filter.type = 'lowpass';
            filter.frequency.value = 100;
            const gain = audioCtx.createGain();
            gain.gain.value = 0.05;
            ambientSource.connect(filter);
            filter.connect(gain);
            gain.connect(audioCtx.destination);
            ambientSource.start();
        }

        function stopSpaceAmbience() {
            if (ambientSource) {
                ambientSource.stop();
                ambientSource = null;
            }
        }

        let gameState = 'START';
        let score = 0;
        let lives = 3;
        let timeLeft = 180;
        let lastTime = 0;
        let meteorTimer = 0;
        let meteorInterval = 2000;
        let currentTarget = 0;
        let currentTargetType = ''; // 'double', 'half', 'friend10'
        
        const DIFFICULTY_SETTINGS = {
            easy: { max: 10, interval: 2500, speed: 1.5 },
            medium: { max: 20, interval: 2000, speed: 2 },
            hard: { max: 50, interval: 1500, speed: 2.5 }
        };

        const player = {
            x: 0,
            y: 0,
            w: 60,
            h: 50,
            speed: 8,
            movingLeft: false,
            movingRight: false
        };

        const meteors = [];
        const lasers = [];
        const particles = [];
        const floatingTexts = [];

        function init() {
            resize();
            window.addEventListener('resize', resize);
            document.addEventListener('keydown', (e) => handleKey(e, true));
            document.addEventListener('keyup', (e) => handleKey(e, false));
            
            // Écouteurs Tactiles : Zones gauche/droite
            canvas.addEventListener('touchstart', handleTouch, { passive: false });
            canvas.addEventListener('touchmove', handleTouch, { passive: false });
            canvas.addEventListener('touchend', () => {
                player.movingLeft = false;
                player.movingRight = false;
            });

            fireBtn.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (gameState === 'PLAYING') fire();
            });
        }

        function handleTouch(e) {
            e.preventDefault();
            if (gameState !== 'PLAYING') return;
            const touch = e.touches[0];
            const middleX = window.innerWidth / 2;

            if (touch.clientX < middleX) {
                player.movingLeft = true;
                player.movingRight = false;
            } else {
                player.movingRight = true;
                player.movingLeft = false;
            }
        }

        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            player.x = canvas.width / 2 - player.w / 2;
            player.y = canvas.height - 100;
        }

        function handleKey(e, isPressed) {
            if (e.code === 'ArrowLeft' || e.code === 'KeyA') player.movingLeft = isPressed;
            if (e.code === 'ArrowRight' || e.code === 'KeyD') player.movingRight = isPressed;
            if (isPressed && e.code === 'Space' && gameState === 'PLAYING') fire();
        }

        function fire() {
            lasers.push({
                x: player.x + player.w / 2 - 4,
                y: player.y,
                w: 9,
                h: 33,
                speed: 10
            });
            playSound(400, 'square', 0.1);
        }

        function generateNewTarget() {
            const config = DIFFICULTY_SETTINGS[diffSelect.value];
            const mode = modeSelect.value;
            
            if (mode === 'doubles') {
                const possible = [];
                for (let i = 2; i <= config.max; i++) possible.push(i);
                currentTarget = possible[Math.floor(Math.random() * possible.length)];
                
                // Choisir au hasard entre chercher le double ou la moitié (si pair)
                if (currentTarget % 2 === 0 && Math.random() > 0.5) {
                    currentTargetType = 'half';
                    targetInstEl.textContent = "Trouve la moitié de";
                } else {
                    currentTargetType = 'double';
                    targetInstEl.textContent = "Trouve le double de";
                }
            } else {
                // Mode Amis de 10
                currentTargetType = 'friend10';
                currentTarget = Math.floor(Math.random() * 10) + 1;
                targetInstEl.textContent = "Complément à 10 de";
            }
            
            targetValEl.textContent = currentTarget;
        }

        function spawnMeteor() {
            const config = DIFFICULTY_SETTINGS[diffSelect.value];
            const mode = modeSelect.value;
            const size = 60 + Math.random() * 40;
            let value;
            const rand = Math.random();

            if (rand < 0.3) {
                // Créer une bonne réponse
                if (mode === 'doubles') {
                    value = (currentTargetType === 'double') ? currentTarget * 2 : currentTarget / 2;
                } else {
                    value = 10 - currentTarget;
                }
            } else {
                // Créer une mauvaise réponse
                const maxRange = (mode === 'doubles') ? config.max * 2 : 12;
                value = Math.floor(Math.random() * maxRange) + 1;
                // S'assurer que ce n'est pas la bonne réponse par accident
                const correct = (mode === 'doubles') ? (currentTargetType === 'double' ? currentTarget * 2 : currentTarget / 2) : (10 - currentTarget);
                if (value === correct) value++;
            }

            meteors.push({
                x: Math.random() * (canvas.width - size),
                y: -size,
                w: size,
                h: size,
                speed: config.speed + (Math.random() * 1),
                value: value,
                img: images.meteors[Math.floor(Math.random() * 4)],
                rot: 0,
                rotSpeed: (Math.random() - 0.5) * 0.05
            });
        }

        function createExplosion(x, y, color) {
            for (let i = 0; i < 15; i++) {
                particles.push({
                    x, y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    life: 1.0,
                    color: color
                });
            }
        }

        function showFloatingText(text, x, y, color) {
            floatingTexts.push({
                text, x, y, color,
                life: 1.0,
                vy: -2
            });
        }

        function update(deltaTime) {
            if (gameState !== 'PLAYING') return;

            timeLeft -= deltaTime / 1000;
            if (timeLeft <= 0) endGame("TEMPS ÉCOULÉ !");
            
            const mins = Math.floor(timeLeft / 60);
            const secs = Math.floor(timeLeft % 60);
            timerEl.textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

            if (player.movingLeft && player.x > 0) player.x -= player.speed;
            if (player.movingRight && player.x < canvas.width - player.w) player.x += player.speed;

            meteorTimer += deltaTime;
            if (meteorTimer > meteorInterval) {
                spawnMeteor();
                meteorTimer = 0;
            }

            for (let i = meteors.length - 1; i >= 0; i--) {
                const m = meteors[i];
                m.y += m.speed;
                m.rot += m.rotSpeed;

                if (m.x < player.x + player.w && m.x + m.w > player.x &&
                    m.y < player.y + player.h && m.y + m.h > player.y) {
                    lives--;
                    livesEl.textContent = lives;
                    createExplosion(player.x + player.w/2, player.y + player.h/2, '#ff0000');
                    playSound(150, 'sawtooth', 0.3);
                    meteors.splice(i, 1);
                    if (lives <= 0) endGame("VAISSEAU DÉTRUIT !");
                    continue;
                }
                if (m.y > canvas.height) meteors.splice(i, 1);
            }

            for (let i = lasers.length - 1; i >= 0; i--) {
                const l = lasers[i];
                l.y -= l.speed;
                let hit = false;
                for (let j = meteors.length - 1; j >= 0; j--) {
                    const m = meteors[j];
                    if (l.x < m.x + m.w && l.x + l.w > m.x && l.y < m.y + m.h && l.y + l.h > m.y) {
                        const mode = modeSelect.value;
                        let isCorrect = false;
                        
                        if (mode === 'doubles') {
                            isCorrect = (currentTargetType === 'double') ? (m.value === currentTarget * 2) : (m.value === currentTarget / 2);
                        } else {
                            isCorrect = (m.value === 10 - currentTarget);
                        }

                        if (isCorrect) {
                            score += 10;
                            scoreEl.textContent = score;
                            createExplosion(m.x + m.w/2, m.y + m.h/2, '#4ade80');
                            showFloatingText("+10", m.x + m.w/2, m.y, '#4ade80');
                            playSound(600, 'sine', 0.2);
                            generateNewTarget();
                        } else {
                            score = Math.max(0, score - 5);
                            scoreEl.textContent = score;
                            createExplosion(m.x + m.w/2, m.y + m.h/2, '#ef4444');
                            showFloatingText("-5", m.x + m.w/2, m.y, '#ef4444');
                            playSound(100, 'square', 0.2);
                        }
                        meteors.splice(j, 1);
                        lasers.splice(i, 1);
                        hit = true;
                        break;
                    }
                }
                if (!hit && l.y < -l.h) lasers.splice(i, 1);
            }

            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx; p.y += p.vy; p.life -= 0.02;
                if (p.life <= 0) particles.splice(i, 1);
            }

            for (let i = floatingTexts.length - 1; i >= 0; i--) {
                const t = floatingTexts[i];
                t.y += t.vy; t.life -= 0.015;
                if (t.life <= 0) floatingTexts.splice(i, 1);
            }
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white';
            for(let i=0; i<50; i++) {
                const x = (Math.sin(i * 123) * 0.5 + 0.5) * canvas.width;
                const y = ((Date.now() * 0.05 + i * 456) % canvas.height);
                ctx.globalAlpha = 0.3;
                ctx.fillRect(x, y, 2, 2);
            }
            ctx.globalAlpha = 1.0;

            meteors.forEach(m => {
                ctx.save();
                ctx.translate(m.x + m.w/2, m.y + m.h/2);
                ctx.rotate(m.rot);
                ctx.drawImage(m.img, -m.w/2, -m.h/2, m.w, m.h);
                ctx.restore();
                ctx.fillStyle = 'white';
                ctx.font = 'bold 20px sans-serif';
                ctx.textAlign = 'center';
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 3;
                ctx.strokeText(m.value, m.x + m.w/2, m.y + m.h/2 + 7);
                ctx.fillText(m.value, m.x + m.w/2, m.y + m.h/2 + 7);
            });

            lasers.forEach(l => ctx.drawImage(images.laser, l.x, l.y, l.w, l.h));

            particles.forEach(p => {
                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, 3, 0, Math.PI * 2);
                ctx.fill();
            });
            ctx.globalAlpha = 1.0;

            ctx.drawImage(images.ship, player.x, player.y, player.w, player.h);

            floatingTexts.forEach(t => {
                ctx.globalAlpha = t.life;
                ctx.fillStyle = t.color;
                ctx.font = 'bold 24px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(t.text, t.x, t.y);
            });
            ctx.globalAlpha = 1.0;
        }

        function gameLoop(timestamp) {
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            update(deltaTime);
            draw();
            requestAnimationFrame(gameLoop);
        }

        function startGame() {
            audioCtx.resume();
            startSpaceAmbience();
            targetDisplay.classList.remove('hidden');
            touchControls.classList.remove('hidden');
            const settings = DIFFICULTY_SETTINGS[diffSelect.value];
            meteorInterval = settings.interval;
            score = 0; lives = 3; timeLeft = 180;
            scoreEl.textContent = score;
            livesEl.textContent = lives;
            meteors.length = 0; lasers.length = 0;
            particles.length = 0; floatingTexts.length = 0;
            gameState = 'PLAYING';
            overlay.classList.add('hidden');
            generateNewTarget();
        }

        function endGame(reason) {
            gameState = 'GAMEOVER';
            stopSpaceAmbience();
            touchControls.classList.add('hidden');
            overlayTitle.textContent = reason;
            overlayMsg.innerHTML = `<div class="text-center">MISSION TERMINÉE !<br><br><b>Score Final : ${score}</b><br>Continue tes efforts !</div>`;
            startBtn.textContent = "REESSAYER";
            overlay.classList.remove('hidden');
        }
        
        homeBtn.addEventListener('click', () => {
            gameState = 'START';
            stopSpaceAmbience();
            targetDisplay.classList.add('hidden');
            touchControls.classList.add('hidden');
            overlayTitle.textContent = "PAUSE";
            overlayMsg.innerHTML = `<div class="text-center">Partie interrompue.<br><br><b>Score actuel : ${score}</b></div>`;
            startBtn.textContent = "REPRENDRE / REJOUER";
            overlay.classList.remove('hidden');
        });

        startBtn.addEventListener('click', startGame);
        init();
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>

